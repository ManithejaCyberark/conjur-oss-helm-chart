# Deploying Conjur OSS and Some Example Applications on Kubernetes-in-Docker (KinD)

This directory provides a set of demonstration scripts that can be used to:

- Create a [Kubernetes-in-Docker](https://github.com/kubernetes-sigs/kind)
  (KinD) cluster on your local machine
- Helm install a Conjur OSS cluster on that KinD cluster
- Enable the
  [Conjur Kubernetes Authenticator](https://docs.conjur.org/Latest/en/Content/Operations/Services/k8s_auth.htm)
  (authn-k8s) (as a security admin)
- Load Conjur security policies for some example applications
  (as a security admin)
- Deploy instances of a simple "Pet Store" application each using
  one of the following Conjur authentication broker/clients:
  - [Secretless Broker](https://github.com/cyberark/secretless-broker) sidecar container
  - [Conjur Kubernetes Authenticator Client](https://github.com/cyberark/conjur-authn-k8s-client)
    sidecar container
  - [Conjur Kubernetes Authenticator Client](https://github.com/cyberark/conjur-authn-k8s-client)
    init container
  (as an application developer/deployer)

After the demo applications have been deployed, you can view
the Conjur policy YAML files and the Kubernetes YAML manifest files 
that were generated by the scripts, as working examples of
how to deploy applications that use Conjur Kubernetes authentication.
(See the
[Viewing Conjur Policy and Kubernetes Deployment Manifests](#viewing-conjur-policy-and-kubernetes-deployment-manifests)
section below for details.)

## Table of Contents

  * [Background](#background)
    + [Kubernetes-in-Docker (KinD)](#kubernetes-in-docker-kind)
    + [Kubernetes Conjur Demo Scripts](#kubernetes-conjur-demo-scripts)
    + [The Conjur Kubernetes Authenticator and Conjur Application Identity](#the-conjur-kubernetes-authenticator-and-conjur-application-identity)
  * [Prerequisites](#prerequisites)
    + [kubectl, Version 1.13 or Newer](#kubectl-version-113-or-newer)
    + [kind Binary, Version 0.7.0 or Newer](#kind-binary-version-070-or-newer)
    + [Helm Version 3.1 or Newer](#helm-version-31-or-newer)
  * [Creating KinD Cluster, Installing Conjur OSS, and Deploying the Demo Applications](#creating-kind-cluster-installing-conjur-oss-and-deploying-the-demo-applications)
    + [Customizing the Demo Environment Settings](#customizing-the-demo-environment-settings)
    + [Deploying "All the Things"](#deploying-all-the-things)
  * [Viewing the Conjur Policy and Kubernetes Deployment YAML Manifests](#viewing-the-conjur-policy-and-kubernetes-deployment-yaml-manifests)
  * [Enabling Conjur Debug Logging](#enabling-conjur-debug-logging)
  * [Deleting the Kubernetes Conjur Demo Applications](#deleting-the-kubernetes-conjur-demo-applications)
  * [Uninstalling Conjur OSS via Helm Delete](#uninstalling-conjur-oss-via-helm-delete)

## Background

### Kubernetes-in-Docker (KinD)

[Kubernetes-in-Docker](https://github.com/kubernetes-sigs/kind), or KinD,
is a tool for running local Kubernetes clusters using Docker container
"nodes". KinD supports multiple-node clusters, and can be run on Linux,
macOS, or Windows hosts.

### Kubernetes Conjur Demo Scripts

This demonstration makes use of the scripts in the
[Kubernetes Conjur Demo](https://github.com/conjurdemos/kubernetes-conjur-demo)
Github respository. These scripts can be used to deploy a few instances of
the [Pet Store](https://github.com/conjurdemos/pet-store-demo/) demo
application to demonstrate retrieval of secrets from a Conjur OSS server.

Using these scripts, you can deploy the
[Pet Store](https://github.com/conjurdemos/pet-store-demo/) demo application
using the following authentication broker/clients:

- [Secretless Broker](https://github.com/cyberark/secretless-broker) sidecar
  container to manage the database connection
- [Conjur Kubernetes Authenticator Client](https://github.com/cyberark/conjur-authn-k8s-client)
  sidecar container to provide the Conjur access token, and
  [Summon](https://github.com/cyberark/summon) to inject the database
  credentials into the application environment
- [Conjur Kubernetes Authenticator Client](https://github.com/cyberark/conjur-authn-k8s-client)
  init container to provide the Conjur access token, and
  [Summon](https://github.com/cyberark/summon) to inject the database
  credentials into the application environment

The demo script workflow can be split into three phases:

- **Demo preparation**
  - Check required environment settings
- **Security Admin steps**
  These steps are normally performed by a security admin, e.g.:
  - Create a Conjur CLI deployment for scripts to use
  - Load Conjur policies for the application
  - Initialize Conjur's TLS Certificate Authority (CA)
- **Demo Application Deployment**
  - Create demo namespace
  - Create RoleBinding to allow Conjur to access resources in the namespace
  - Retrieve the Conjur CA certificate to add to applications trust store
  - Build and push application containers
  - Deploy the application instances using the Conjur authentication
    mechanisms described above.

### The Conjur Kubernetes Authenticator and Conjur Application Identity

The Conjur authentication broker/clients listed above are essentially
authentication proxies for the application. They authenticate with
Conjur for the application using the 
[Conjur Kubernetes Authenticator](https://docs.conjur.org/Latest/en/Content/Operations/Services/k8s_auth.htm)
(a.k.a. `authn-k8s`) authentication plugin that must be enabled on the Conjur
server.

The `authn-k8s` plugin makes use of several forms of 
[Conjur application identity](https://docs.conjur.org/Latest/en/Content/Integrations/Kubernetes_AppIdentity.htm?TocPath=Integrations%7COpenShift%252C%20Kubernetes%252C%20and%20GKE%7C_____2)
to positively identify the application. In the case of Kubernetes Conjur demo
scripts, the application identity that is used are the following
attributes of the application instance:
- Kubernetes Namespace name
- Kubernetes ServiceAccount name
- Kubernetes Deployment name
If all three of the above resource names match what has been specified
in Conjur policy (e.g. by a security administrator), then the application is
permitted to access secrets as dictated by that policy.

## Prerequisites

### kubectl, Version 1.13 or Newer

The scripts in this directory require that you have installed the `kubectl`
binary that is Version 1.13 or newer. To install the
`kubectl` binary, follow the instructions in the
[Install and Set Up kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
guide.

### kind Binary, Version 0.7.0 or Newer

The scripts in this directory require that you have installed the `kind`
binary that is version 0.7.0 or newer. To install KinD, follow the
instructions in the
[kubectl Installation Guide](https://kind.sigs.k8s.io/docs/user/quick-start/#installation).

_**NOTE: A software loadbalancer is not required to be installed in the
   KinD cluster in order to run these demos.**_

### Helm Version 3.1 or Newer

The scripts in this directory require that you have installed the `helm`
binary that is version 3.1 or newer. To install Helm, follow the procedures
documented in the [Helm Install Guide](https://helm.sh/docs/intro/install/).

## Creating KinD Cluster, Installing Conjur OSS, and Deploying the Demo Applications

Now that you've satisfied all of the requirements listed in previous section,
you are **almost** ready to run the scripts in this directory to:
- Create a KinD cluster
- Install Conjur OSS on that KinD cluster (as security administrator)
- Load Conjur security policies (as security administrator)
- Load deploy multiple instances of a demo application using
  Secretless Broker, Kubernetes authentication client sidecar container,
  and Kubernetes Authentication Client init container (as an application
  deployer).

But first, you'll need to customize and source some environment settings as
described in the follwing sections.

### Customizing the Demo Environment Settings

#### Modify or Make a Personal Copy of 'customize.env' to Modify

There are several (commented out) environment variable settings in the
'customize.env' file that can uncommented and modified to change how the
demo scripts are run. You can do this by either modifying the existing
`customize.env` file, or creating your own copy to modify and using
the `-c <customization-file>` command line argument for the `start` script.

#### Configuring a Docker Registry

Kubernetes Conjur Demo scripts build and push several demo container images
to a Docker registry so that they can then be pulled by KinD. You can choose
to have the scripts create and use a local, insecure Docker registry
by exporting the following:

```
     export USE_DOCKER_LOCAL_REGISTRY=true
```

Or you can use a public Docker registry (e.g. DockerHub) by providing
your Docker credentials. This is done by uncommenting the following lines
in `customize.env` and substituting your Docker credentials:

```
#export DOCKER_REGISTRY_URL="docker.io"
#export DOCKER_REGISTRY_PATH="<your-dockerhub-org-or-username>"
#export DOCKER_USERNAME="<your-dockerhub-username>"
#export DOCKER_PASSWORD="<your-dockerhub-password>"
#export DOCKER_EMAIL="<your-dockerhub-email>"
```

For example, if you are using a personal DockerHub account, the environment
settings might look something like this:

```
export DOCKER_REGISTRY_URL="docker.io"
export DOCKER_REGISTRY_PATH="firstnamelastname"
export DOCKER_USERNAME="firstnamelastname"
export DOCKER_PASSWORD="GreatGooglyMoogly"
export DOCKER_EMAIL="firstname.lastname@example.com"
```

#### Other Customizable Options

There are other script options in `customize.env` that you may want to
uncomment and modify, depending upon your needs.

For example, if you already have a KinD cluster available, you can
uncomment/modify the following line:

```sh-session
#export CREATE_KIND_CLUSTER="<true-or-false>"
```

and modify it so that it reads:
```sh-session
export CREATE_KIND_CLUSTER="false"
```

### Deploying "All the Things"

After customizing the `customize.env` file either directly or by
making a personal, modified copy, you can now run the scripts in this
directory by running either:

```sh-session
./start
```

if you are using `customize.env`, or:

```sh-session
./start -c <your-customization-file>
```

if you are using a modified copy of `customize.env`.

That's all there is to it!

This will create a KinD cluster, install Conjur OSS, load
Conjur security policy, and deploy demo applications.

The deployment of the demo applications will involve cloning the
[Kubernetes Conjur Demo](https://github.com/conjurdemos/kubernetes-conjur-demo)
scripts to the temp/kubernetes-conjur-demo directory, and then run those
demo scripts to deploy the demo application instances.

If everything is successful, you should see the following verification
of Conjur secrets being retrieved:

```sh-session
Querying init app

[{"id":1,"name":"Mr. Init"},{"id":2,"name":"Mr. Init"}]

Querying init app with hosts outside apps

[{"id":1,"name":"Mr. Init"},{"id":2,"name":"Mr. Init"}]

Querying sidecar app

[{"id":1,"name":"Mr. Sidecar"}]

Querying secretless app

[{"id":1,"name":"Mr. Secretless"}]

Stopping all port-forwarding
```

## Viewing the Conjur Policy and Kubernetes Deployment YAML Manifests

The Kubernetes Conjur Demo scripts will render both Conjur policy YAML files
as well as Kubernetes deployment manifests for the demo. After the scripts
have been run, these can be viewed in the following subdirectories:

- Conjur Policy YAML files: These can be found in the subdirectory
  `temp/kubernetes-conjur-demo/policy/generated`
- Kubernetes demo deployment manifests: These can be found in the subdirectory
  `temp/kubernetes-conjur-demo/kubernetes`

## Enabling Conjur Debug Logging

If for some reason the scripts fail to deploy applications, or fail to
successfully retrieve Conjur secrets, it may help to enable debug logs
in the Conjur server, and then using `kubectl logs ...` to display
Conjur logs in order to troubleshoot the problem.

To enable Conjur debug logging, use Helm upgrade as follows:

```sh-session
CONJUR_NAMESPACE=conjur-oss
HELM_RELEASE=conjur-oss
helm upgrade \
     -n "$CONJUR_NAMESPACE" \
     --reuse-values \
     --set logLevel=debug \
     "$HELM_RELEASE" \
     ./conjur-oss
```

The Conjur servers logs can then be displayed as follows:

```sh-session
conjur_container="conjur-oss"
pod_name=$(kubectl get pods \
          -n "$CONJUR_NAMESPACE" \
          -l "app=conjur-oss,release=$HELM_RELEASE" \
          -o jsonpath="{.items[0].metadata.name}")
kubectl logs -n "$CONJUR_NAMESPACE" "$pod_name" "$conjur_container"
```

## Deleting the Kubernetes Conjur Demo Applications

The Kubernetes Conjur Demo application deployments can be cleaned up
by deleting the demo namespace:

```sh-session
kubectl delete ns app-test
```

## Uninstalling Conjur OSS via Helm Delete

To remove the Conjur OSS deployment from your KinD cluster, run the following:

```sh-session
CONJUR_NAMESPACE=conjur-oss
HELM_RELEASE=conjur-oss
helm delete -n "$CONJUR_NAMESPACE" "$HELM_RELEASE"
```
